[gd_scene load_steps=10 format=2]

[ext_resource path="res://Resources/Sprites/Textures/chess.png" type="Texture" id=1]
[ext_resource path="res://Scenes/LabelBox.scn" type="PackedScene" id=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

void fragment(){
	COLOR.rgb = texture( TEXTURE , UV*0.5 + vec2(1,1)*TIME ).rgb;
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )

[sub_resource type="GDScript" id=3]
resource_name = "CONNECTION_SETUP"
script/source = "extends NinePatchRect

func _ready():
	$Start.connect(\"button_up\",self,\"_start_pressed\")



func _start_pressed( room_name = $RoomName.text ):
	if( room_name.length() > 0 ):
		NetworkSystem.connectTo( room_name )
		get_tree().change_scene_to( load(\"res://Scenes/MainSceneRoot.tscn\") )

func _connection_succeeded():
	get_tree().change_scene_to( load(\"res://Scenes/MainSceneRoot.tscn\") )

func _room_button_pressed( button : Button ):
	_start_pressed( button.name )"

[sub_resource type="GDScript" id=4]
script/source = "extends LineEdit

func _ready():
	pass

func _on_YourName_text_changed(new_text):
	if( new_text.length() > 0 ):
		GameContext.my_player_state.name = new_text"

[sub_resource type="GDScript" id=5]
script/source = "extends ColorPickerButton

func _ready():
	GameContext.my_player_state.color = self.color

func _on_FavoriteColor_color_changed(color):
	GameContext.my_player_state.color = color
"

[sub_resource type="GDScript" id=6]
script/source = "extends Button

func _ready():
	disabled = true
	text = \"Connecting to server...\"
	
	NetworkSystem.connect(\"connection_succeeded\",self,\"_connected\")
	NetworkSystem.connect(\"connection_failed\",self,\"_connection_failed\")

func _connected():
	disabled = false
	text = \"Just let me in!!!\"

func _connection_failed():
	disabled = true
	text = \"Connetion failed :(\"

"

[sub_resource type="GDScript" id=7]
resource_name = "EXISTANT_ROOMS"
script/source = "extends NinePatchRect

var button_template
func _ready():
	button_template = $List.get_child(0)
	$List.remove_child(button_template)
	for child in $List.get_children():
		child.queue_free()

func _on_List_sort_children():
	$List.rect_size.y = 0
	rect_size.y = $List.rect_size.y + 40


func _on_Timer_timeout():
	for child in $List.get_children():
		if( NetworkSystem.room_list.keys().find(child.name) == -1 ):
			child.name = \"~~~~~~\"
			child.queue_free()
	
	for room_name in NetworkSystem.room_list.keys():
		if( not $List.has_node(room_name) ):
			var new_inst = button_template.duplicate()
			new_inst.name = room_name
			$List.add_child( new_inst )
			new_inst.connect(\"pressed\",
				get_parent().get_node(\"ConnectionSetup\") ,
				\"_room_button_pressed\",
				[ new_inst ]
			)
		
		$List.get_node(room_name).text = room_name + \" (\"+ String(NetworkSystem.room_list[room_name])  +\"/\"+ String(10) +\")\"
"

[node name="Menu" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0

[node name="BG" type="TextureRect" parent="."]
self_modulate = Color( 0.113725, 0.113725, 0.113725, 1 )
show_behind_parent = true
material = SubResource( 2 )
anchor_right = 1.0
anchor_bottom = 1.0
texture = ExtResource( 1 )
expand = true
stretch_mode = 2

[node name="ConnectionSetup" type="NinePatchRect" parent="."]
margin_right = 390.0
margin_bottom = 164.0
texture = ExtResource( 1 )
draw_center = false
region_rect = Rect2( 10, 4, 1, 2 )
patch_margin_left = 2
patch_margin_top = 2
patch_margin_right = 2
patch_margin_bottom = 2
script = SubResource( 3 )

[node name="ColorRect" type="ColorRect" parent="ConnectionSetup"]
show_behind_parent = true
anchor_right = 1.0
anchor_bottom = 1.0
color = Color( 0.160784, 0.160784, 0.160784, 1 )

[node name="YourName" type="LineEdit" parent="ConnectionSetup"]
editor/display_folded = true
margin_left = 88.0
margin_top = 28.0
margin_right = 370.0
margin_bottom = 52.0
script = SubResource( 4 )

[node name="Label" type="Label" parent="ConnectionSetup/YourName"]
anchor_top = 0.5
anchor_bottom = 0.5
margin_left = -78.0
margin_top = -7.0
margin_right = -3.0
margin_bottom = 7.0
text = "Your name:"

[node name="RoomName" type="LineEdit" parent="ConnectionSetup"]
editor/display_folded = true
margin_left = 150.0
margin_top = 95.0
margin_right = 370.0
margin_bottom = 119.0

[node name="Label" type="Label" parent="ConnectionSetup/RoomName"]
anchor_top = 0.5
anchor_bottom = 0.5
margin_left = -140.0
margin_top = -7.0
margin_right = -4.0
margin_bottom = 7.0
text = "Room to join/create:"

[node name="FavoriteColor" type="ColorPickerButton" parent="ConnectionSetup"]
editor/display_folded = true
margin_left = 150.0
margin_top = 60.0
margin_right = 190.0
margin_bottom = 89.0
color = Color( 0.223529, 0.74902, 0.305882, 1 )
script = SubResource( 5 )

[node name="Label" type="Label" parent="ConnectionSetup/FavoriteColor"]
anchor_top = 0.5
anchor_bottom = 0.5
margin_left = -140.0
margin_top = -6.5
margin_right = -10.0
margin_bottom = 7.5
text = "Your favorite color:"

[node name="Start" type="Button" parent="ConnectionSetup"]
margin_left = 10.0
margin_top = 126.0
margin_right = 370.0
margin_bottom = 151.0
text = "Just let me in please"
script = SubResource( 6 )

[node name="ExistantRooms" type="NinePatchRect" parent="."]
margin_left = 410.0
margin_top = 20.0
margin_right = 620.0
margin_bottom = 160.0
texture = ExtResource( 1 )
draw_center = false
region_rect = Rect2( 10, 4, 1, 2 )
patch_margin_left = 2
patch_margin_top = 2
patch_margin_right = 2
patch_margin_bottom = 2
script = SubResource( 7 )

[node name="Timer" type="Timer" parent="ExistantRooms"]
autostart = true

[node name="BG" type="ColorRect" parent="ExistantRooms"]
show_behind_parent = true
anchor_right = 1.0
anchor_bottom = 1.0
color = Color( 0.160784, 0.160784, 0.160784, 0.921569 )

[node name="Title" parent="ExistantRooms" instance=ExtResource( 2 )]
margin_left = -10.0
margin_top = -10.0
margin_right = 99.0
margin_bottom = 14.0
rect_min_size = Vector2( 109, 24 )
rect_pivot_offset = Vector2( 54.5, 12 )
text = "Existant rooms:"

[node name="List" type="VBoxContainer" parent="ExistantRooms"]
anchor_right = 1.0
margin_left = 5.0
margin_top = 30.0
margin_right = -5.0
margin_bottom = 230.0

[node name="Button" type="Button" parent="ExistantRooms/List"]
margin_right = 200.0
margin_bottom = 20.0
text = "Crentes(2/10)"
[connection signal="text_changed" from="ConnectionSetup/YourName" to="ConnectionSetup/YourName" method="_on_YourName_text_changed"]
[connection signal="color_changed" from="ConnectionSetup/FavoriteColor" to="ConnectionSetup/FavoriteColor" method="_on_FavoriteColor_color_changed"]
[connection signal="timeout" from="ExistantRooms/Timer" to="ExistantRooms" method="_on_Timer_timeout"]
[connection signal="sort_children" from="ExistantRooms/List" to="ExistantRooms" method="_on_List_sort_children"]
